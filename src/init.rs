use std::collections::VecDeque;

use super::belt::*;
use super::cell::*;
use super::cli_serialize::*;
use super::config::*;
use super::direction::*;
use super::factory::*;
use super::floor::*;
use super::options::*;
use super::machine::*;
use super::part::*;
use super::port::*;
use super::port_auto::*;
use super::prio::*;
use super::state::*;
use super::truck::*;
use super::utils::*;
use super::log;

pub fn init(options: &Options, config: &Config, map_str: String) -> ( State, Factory ) {
  // General app state
  let mut state = state_create(options);

  let mut factory = create_factory(options, &mut state, &config, map_str);
  let parts = config_get_available_parts(config);
  log!("available_parts_rhs_menu (4): {:?}", factory.available_parts_rhs_menu);

  // log!("eh? paint_ui_offers {:?}", config.part_nodes);
  // log!("pushing {:?} to paint_ui_offers", factory.available_parts_rhs_menu);

  factory.changed = true; // Store the initial map

  return ( state, factory );
}

// @deprecated
fn old_map() {

  // let map = "\
  //   ...............s.\n\
  //   sb.111bbbbbbbb.b.\n\
  //   .b.111.......b.b.\n\
  //   .b.111bbbbb..bbb.\n\
  //   .b.b.b....bb...b.\n\
  //   .b.b.bbbb..b...b.\n\
  //   .b.b....b..b...b.\n\
  //   .bbb...222.b...b.\n\
  //   ...b...222.b..bb.\n\
  //   sbbb...222.b..b..\n\
  //   ........b..b..bbs\n\
  //   ..bbbbbbb..b.....\n\
  //   ..b.....b..bbbbbd\n\
  //   ..b.....b........\n\
  //   dbb..bbbb........\n\
  //   .....b...........\n\
  //   .....d...........\n\
  //   m1 = ws -> b s:10\n\
  //   m2 = b -> g s:10\n\
  //   s1 = w s:10 c:5\n\
  //   s2 = w s:10 c:5\n\
  //   s3 = s s:10 c:5\n\
  //   s4 = s s:10 c:5\n\
  //   d1 = s\n\
  //   d2 = w\n\
  //   d3 = g\n\
  //   d4 = g\n\
  //   os = w s:10 c:5\n\
  //   os = s s:10 c:5\n\
  //   od = g\n\
  //   om = sw -> b s:10 d:3x2\n\
  //   om = b -> g s:10\n\
  //   om = b -> g s:10 d:3x3\n\
  //   om = b -> g s:10 d:4x4\n\
  // ";
  let map = "\
    d=17x17 r=\n\
    ┌─────────────────────────────────────────────────┐\n\
    │.  .  .  .  .  .  .  .  .  .  .  .  .  .  .  s  .│\n\
    │ ┌───────────────────────────────────────────v─┐ │\n\
    │ │         ┌─┐                               v │ │\n\
    │s>>╗  .  . │1<<═<<═<<═<<═<<═<<═<<═<<═<<╗  .  ║ │.│\n\
    │ │ v       │ │                         ^     v │ │\n\
    │ │ v       │ │                         ^     v │ │\n\
    │.│ ║  .  . │1│ .  .  .  .  .  .  .  .  ║  .  ║ │.│\n\
    │ │ v       │ │                         ^     v │ │\n\
    │ │ v       │ │                         ^     v │ │\n\
    │.│ ║  .  ╔>>1>>╦>>═>>═>>═>>═>>╗  .  .  ╚<<═<<╣ │.│\n\
    │ │ v     ^ └─┘ v              v              ^ │ │\n\
    │ │ v     ^     v              v              ^ │ │\n\
    │.│ ║  .  ║  .  ║  .  .  .  .  ╚>>╗  .  .  .  ║ │.│\n\
    │ │ v     ^     v                 v           ^ │ │\n\
    │ │ v     ^     v                 v           ^ │ │\n\
    │.│ ║  .  ║  .  ╚>>═>>═>>╗  .  .  ║  .  .  .  ║ │.│\n\
    │ │ v     ^              v        v           ^ │ │\n\
    │ │ v     ^              v        v           ^ │ │\n\
    │.│ ║  .  ║  .  .  .  .  ║  .  .  ║  .  .  .  ║ │.│\n\
    │ │ v     ^              v        v           ^ │ │\n\
    │ │ v     ^             ┌v┐       v           ^ │ │\n\
    │.│ ╚>>═>>╬<<╗  .  .  . │2│ .  .  ║  .  .  .  ║ │.│\n\
    │ │       ^  ^          │ │       v           ^ │ │\n\
    │ │       ^  ^          │ │       v           ^ │ │\n\
    │.│ .  .  ║  ║  .  .  . │2│ .  .  ║  .  .  ╔>>╝ │.│\n\
    │ │       ^  ^          │ │       v        ^    │ │\n\
    │ │       ^  ^          │ │       v        ^    │ │\n\
    │s>>═>>═>>╩>>╝  .  .  . │2<<╗  .  ║  .  .  ║  . │.│\n\
    │ │                     └v┘ ^     v        ^    │ │\n\
    │ │                      v  ^    ┌v┐       ^    │ │\n\
    │.│ .  .  .  .  .  .  .  ║  ║  . │3│ .  .  ╚<<═<<s│\n\
    │ │                      v  ^    │ │            │ │\n\
    │ │                      v  ^    │ │            │ │\n\
    │.│ .  ╔<<═<<═<<═<<═<<═<<╣  ╠>>═>>3│ .  .  .  . │.│\n\
    │ │    v                 v  ^    │ │            │ │\n\
    │ │    v                 v  ^    │ │            │ │\n\
    │.│ .  ║  .  .  .  .  .  ║  ║  . │3>>═>>═>>═>>═>>d│\n\
    │ │    v                 v  ^    └─┘            │ │\n\
    │ │    v                 v  ^                   │ │\n\
    │.│ .  ║  .  .  .  .  .  ║  ║  .  .  .  .  .  . │.│\n\
    │ │    v                 v  ^                   │ │\n\
    │ │    v                 v  ^                   │ │\n\
    │d<<═<<╝  .  .  ╔<<═<<═<<╝  ║  .  .  .  .  .  . │.│\n\
    │ │             v           ^                   │ │\n\
    │ │             v           ^                   │ │\n\
    │.│ .  .  .  .  ║  .  .  .  ║  .  .  .  .  .  . │.│\n\
    │ │             v           ^                   │ │\n\
    │ └─────────────v───────────^───────────────────┘ │\n\
    │.  .  .  .  .  d  .  .  .  s  .  .  .  .  .  .  .│\n\
    └─────────────────────────────────────────────────┘\n\
  ";
  let map = "\
    d=17x17\n\
    ┌─────────────────────────────────────────────────┐\n\
    │.  .  .  .  .  .  .  s  .  s  s  .  .  .  .  .  .│\n\
    │ ┌───────────────────v─────v──v────────────────┐ │\n\
    │ │      ┌───────┐    v     v  v       ┌───────┐│ │\n\
    │s>>═>>╗ │1  1  1<<╗  ╚>>╗  ║  ╚>>═>>═>>2  2  2││.│\n\
    │ │    v │       │ ^     v  v          │       ││ │\n\
    │ │    v │       │ ^     v  v          │       ││ │\n\
    │.│ ╔<<╝ │1  1  1│ ╚<<═<<╝  ╚>>═>>═>>═>>2  2  2││.│\n\
    │ │ v    │       │                     │       ││ │\n\
    │ │ v    │       │                     │       ││ │\n\
    │.│ ║  ╔>>1  1  1│ ╔<<╗  ╔<<═<<═<<═<<═<<2  2  2││.│\n\
    │ │ v  ^ └v─────v┘ v  ^  v             └───────┘│ │\n\
    │ │ v  ^  v     v  v  ^  v                      │ │\n\
    │.│ ╚>>╝  ╚>>╗  ║  ║  ╚<<╝  ╔>>═>>╗  ╔>>═>>═>>╗ │.│\n\
    │ │          v  v  v        ^     v  ^        v │ │\n\
    │ │          v  v ┌v──────┐ ^     v ┌^──────┐ v │ │\n\
    │.│ ╔>>═>>╗  ║  ║ │3  3  3│ ║  ╔<<╝ │4  4  4│ ║ │.│\n\
    │ │ ^     v  v  v │       │ ^  v    │       │ v │ │\n\
    │ │ ^     v  v  v │       │ ^  v    │       │ v │ │\n\
    │.│ ║  ╔<<╝  ║  ║ │3  3  3>>╝  ╚>>═>>4  4  4│ ║ │.│\n\
    │ │ ^  v     v  v │       │         │       │ v │ │\n\
    │ │ ^  v     v  v │       │         │       │ v │ │\n\
    │.│ ║  ╚>>╗  ║  ║ │3  3  3<<╗  ╔>>═>>4  4  4│ ║ │.│\n\
    │ │ ^     v  v  v └──────^┘ ^  ^    └───────┘ v │ │\n\
    │ │ ^     v  v  v        ^  ^  ^              v │ │\n\
    │.│ ║  ╔<<╝  ║  ╚>>═>>═>>╝  ║  ╚<<═<<═<<═<<╗  ║ │.│\n\
    │ │ ^  v     v              ^              ^  v │ │\n\
    │ │ ^  v     v              ^    ┌───────┐ ^  v │ │\n\
    │.│ ║  ╚>>╗  ╚>>═>>═>>═>>═>>╝  ╔>>8  8  8│ ║  ║ │.│\n\
    │ │ ^     v                    ^ │       │ ^  v │ │\n\
    │ │ ^    ┌v──────┐   ┌───────┐ ^ │       │ ^  v │ │\n\
    │.│ ║  ╔>>5  5  5│ ╔>>6  6  6│ ║ │8  8  8│ ║  ║ │.│\n\
    │ │ ^  ^ │       │ ^ │       │ ^ │       │ ^  v │ │\n\
    │ │ ^  ^ │       │ ^ │       │ ^ │       │ ^  v │ │\n\
    │s>>╝  ║ │5  5  5│ ║ │6  6  6│ ║ │8  8  8>>╝  ║ │.│\n\
    │ │    ^ │       │ ^ │       │ ^ └^──────┘    v │ │\n\
    │ │    ^ │       │ ^ │       │ ^  ^           v │ │\n\
    │s>>═>>╝ │5  5  5│ ║ │6  6  6>>╝  ╚<<═<<═<<╗  ║ │.│\n\
    │ │      └v──────┘ ^ └^──────┘             ^  v │ │\n\
    │ │       v        ^  ^          ┌───────┐ ^  v │ │\n\
    │.│ ╔<<═<<╝  ╔>>╗  ║  ║  ╔>>═>>═>>7  7  7│ ║  ║ │.│\n\
    │ │ v        ^  v  ^  ^  ^       │       │ ^  v │ │\n\
    │ │ v        ^  v  ^  ^  ^       │       │ ^  v │ │\n\
    │.│ ║  ╔>>╗  ║  ║  ║  ║  ║  ╔>>═>>7  7  7│ ║  ║ │.│\n\
    │ │ v  ^  v  ^  v  ^  ^  ^  ^    │       │ ^  v │ │\n\
    │ │ v  ^  v  ^  v  ^  ^  ^  ^    │       │ ^  v │ │\n\
    │.│ ╚>>╝  ╚>>╝  ╚>>╝  ║  ║  ╚<<╗ │7  7  7>>╝  ║ │.│\n\
    │ │                   ^  ^     ^ └───────┘    v │ │\n\
    │ └───────────────────^──^─────^──────────────v─┘ │\n\
    │.  .  .  .  .  .  .  s  s  .  s  .  .  .  .  d  .│\n\
    └─────────────────────────────────────────────────┘\n\
    s1 = r s:0 c:100\n\
    s2 = i s:0 c:100\n\
    s3 = p s:0 c:100\n\
    s4 = e s:0 c:100\n\
    s5 = n s:0 c:100\n\
    s6 = n s:0 c:100\n\
    s7 = k s:0 c:100\n\
    s8 = r s:0 c:100\n\
    s9 = e s:0 c:100\n\
    m1 = . r . . e . . r . -> W s:2000\n\
    m2 = i p p i p p i p p -> D s:2000\n\
    m3 = . W . W D W . W . -> C s:2000\n\
    m4 = . . . C o . . . . -> K s:2000\n\
    m5 = . . . n n n n n n -> Q s:2000\n\
    m6 = . Q . k k k k k k -> l s:2000\n\
    m7 = . r . . e . . r . -> W s:2000\n\
    m8 = . . . W l W . . . -> o s:2000\n\
    d1\n\
    os = r s:2000 c:100\n\
    os = e s:2000 c:100\n\
    os = i s:2000 c:100\n\
    os = p s:2000 c:100\n\
    os = n s:2000 c:100\n\
    os = k s:2000 c:100\n\
    od =  \n\
    om = s . . w . . . . . -> t s:2000 d:3x3\n\
  ";
}
